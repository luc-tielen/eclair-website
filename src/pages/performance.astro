---
import LineChart from "../components/LineChart";
import { Line } from "react-chartjs-2";
import benchmarkData from "../../performance/historical-data.json";

const benchDataByReportName = {};

benchmarkData.forEach((datapoint) => {
  const date = datapoint.date;
  const commitHash = datapoint.commitHash;
  datapoint.results.forEach((result) => {
    const reportName = result.reportName;
    const measurement = {
      date,
      commitHash,
      values: result.values,
    };
    benchDataByReportName[reportName] = benchDataByReportName[reportName]
      ? benchDataByReportName[reportName].concat(measurement)
      : [measurement];
  });
});

const toChartData = (reportName, benchData) => ({
  labels: benchData.map((data) => data.date),
  datasets: [
    {
      type: "line",
      data: benchData.map((point) => point.values.estimated),
      borderColor: "#fcd34d",
      pointRadius: 0,
    },
    {
      type: "line",
      data: benchData.map((point) => point.values.lowerBound),
      backgroundColor: "rgba(253, 224, 71, 0.2)",
      borderColor: "transparent",
      pointRadius: 0,
      pointBackgroundColor: "transparent",
      fill: 0,  // fill goes to line 0
    },
    {
      type: "line",
      data: benchData.map((point) => point.values.upperBound),
      backgroundColor: "rgba(253, 224, 71, 0.2)",
      borderColor: "transparent",
      pointRadius: 0,
      pointBackgroundColor: "transparent",
      fill: 0,  // fill goes to line 0
    },
  ],
});

---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width" />
    <meta name="generator" content={Astro.generator} />
    <title>Astro</title>
  </head>
  <body>
    <main class="px-4 pt-2 flex flex-col gap-1">
      <h1 class="text-2xl font-bold pb-2">Performance tracking</h1>
      <p>
        Below are a set of benchmarks used to keep track of the runtime
        performance of Eclair. The benchmarks are part of the main repository
        and can be found
        <a href="https://github.com/luc-tielen/eclair-lang/blob/main/benchmarks/src/Main.hs" class="text-blue-500 visited:text-indigo-500 hover:underline">here</a>.
      </p>
      {
        Object.entries(benchDataByReportName).map(
          ([reportName, benchData], i) => (
            <LineChart
              title={reportName}
              key={`chart-${i}`}
              data={toChartData(reportName, benchData)}
              client:only
            />
          )
        )
      }
    </main>
  </body>
</html>
